(this["webpackJsonpthree-billboard-reflection-demo"]=this["webpackJsonpthree-billboard-reflection-demo"]||[]).push([[0],{56:function(e,r,n){},75:function(e,r,n){"use strict";n.r(r);var t=n(24),a=n.n(t),o=n(1),l=(n(56),n(8)),i=n(9),c=n(18),s=n(42),u=n(12),d=n(79),f=n(78),b=n(45),v=n(46),p=n(47),m=n(31),g=n(0),h=n(2),x=n(3),y=n(28),_=n(50),O=/#pragma unroll_loop_start\s+for\s*\(\s*int\s+i\s*=\s*(\d+)\s*;\s*i\s*<\s*(\d+)\s*;\s*i\s*\+\+\s*\)\s*{([\s\S]+?)}\s+#pragma unroll_loop_end/g;function j(e,r,n,t){for(var a="",o=parseInt(r);o<parseInt(n);o++)a+=t.replace(/\[\s*i\s*\]/g,"[ "+o+" ]").replace(/UNROLLED_LOOP_INDEX/g,o);return a}var R="\nvarying vec3 vPosition;\nvarying vec3 cameraDirection;\n",M="\nvPosition = (modelMatrix * vec4(position, 1.)).xyz;\ncameraDirection = vPosition - cameraPosition;\n",C="\n".concat("\n// source: https://stackoverflow.com/a/24390149/7626841\nfloat mip_map_level(in vec2 texture_coordinate){\n  vec2  dx_vtc = dFdx(texture_coordinate);\n  vec2  dy_vtc = dFdy(texture_coordinate);\n  \n  float delta_max_sqr = max(dot(dx_vtc, dx_vtc), dot(dy_vtc, dy_vtc));\n\n  return 0.5 * log2(delta_max_sqr);\n}","\n").concat("\nconst float SRGB_INVERSE_GAMMA = 2.2;\n\nvec3 srgb_to_rgb_approx(vec3 srgb) {\n    return pow(srgb, vec3(SRGB_INVERSE_GAMMA));\n}","\n\n").concat("\nvec3 intersectTriangle(vec3 rayOrig, vec3 rayDir, vec3 vector0, vec3 vector1, vec3 vector2){\n      float u, v, t;\n      vec3 e0, e1;\n\n      float det, invDet;\n\n      e0 = vector1 - vector0;\n      e1 = vector2 - vector0;\n\n      vec3 pVec = cross(rayDir, e1);\n\n      det = dot(e0, pVec);\n      invDet = 1. / det;\n\n      vec3 tVec = rayOrig - vector0;\n\n      u = dot(tVec, pVec) * invDet;\n\n      vec3 qVec = cross(tVec, e0);\n\n      v = dot(rayDir, qVec) * invDet;\n\n      t = dot(e1, qVec) * invDet;\n\n      return vec3(u, v, t);\n    }\n","\n\nvec4 computeBillboardReflection(vec3 wPos, vec3 wReflectVec, inout float shortestOpaqueBillboardDistance, float roughnessValue,\n  mat4 matrixWorld, sampler2D tBillboard, vec3 color, float rayFalloff, float opacity){\n  \n  vec4 reflectClr = vec4(0);\n  \n  vec3 vector0 = vec3( 1.,  0.,  1.);\n  vec3 vector1 = vec3(-1.,  0., -1.);\n  vec3 vector2 = vec3(-1.,  0.,  1.);\n\n  vector0 = (matrixWorld * vec4(vector0, 1.)).xyz;\n  vector1 = (matrixWorld * vec4(vector1, 1.)).xyz;\n  vector2 = (matrixWorld * vec4(vector2, 1.)).xyz;\n\n  vec3 uvt = intersectTriangle(wPos, wReflectVec, vector2, vector0, vector1);\n\n  // check if the reflecting billboard's distance is higher than the current lowest distance of an opaque billboard\n  if(shortestOpaqueBillboardDistance <= uvt.z){\n    // return no reflection\n    return reflectClr;\n  }\n\n  // check if the reflected ray hit a billboard\n  if(uvt.x > 0. && uvt.x < 1. &&    uvt.y > 0. && uvt.y < 1.){\n    if(uvt.z <= 0.001){\n      return reflectClr;\n    }\n\n    // get the reflected color\n    #ifdef REFLECTION_ROUGHNESS_BLUR\n      ivec2 texSize = textureSize(tBillboard, 0);\n      float mip = mip_map_level(uvt.xy * float(texSize));\n\n      float pixels = float(max(texSize.x, texSize.y));\n      pixels *= pixels;\n\n      float scale = log2(pixels) * REFLECTION_ROUGHNESS_MAP_BLUR_INTENSITY;\n\n      vec4 reflectedBillboardClr = textureLod(tBillboard, uvt.xy, max(mip, roughnessValue * scale));\n    #else\n      vec4 reflectedBillboardClr = texture(tBillboard, uvt.xy);\n    #endif\n    \n    if(opacity != 1.){\n      reflectedBillboardClr.a *= sqrt(opacity);\n    }\n\n    // make the ray's intensity fall off by distance to prevent artifacts (e.g. reflection visible behind wall)\n    if(rayFalloff != 0.){\n      float rayToCameraDistance = distance(cameraPosition, wPos);\n\n      reflectedBillboardClr.a *= min(1., 1. / (rayToCameraDistance * rayFalloff));\n    }\n    \n    if(reflectedBillboardClr.a == 1.){\n      shortestOpaqueBillboardDistance = uvt.z;\n    }\n\n    // final reflected color\n    reflectClr = vec4(\n      srgb_to_rgb_approx(reflectedBillboardClr.rgb) * color, 1.\n    )\n    * reflectedBillboardClr.a * (1. - roughnessValue * roughnessValue);\n  }\n\n  return reflectClr;\n}\n"),B="\n#if defined( RE_IndirectDiffuse )\n\t#ifdef USE_LIGHTMAP\n\t\tvec4 lightMapTexel= texture2D( lightMap, vUv2 );\n\t\tvec3 lightMapIrradiance = lightMapTexelToLinear( lightMapTexel ).rgb * lightMapIntensity;\n\t\t#ifndef PHYSICALLY_CORRECT_LIGHTS\n\t\t\tlightMapIrradiance *= PI; // factor of PI should not be present; included here to prevent breakage\n\t\t#endif\n\t\tirradiance += lightMapIrradiance;\n\t#endif\n\t#if defined( USE_ENVMAP ) && defined( STANDARD ) && defined( ENVMAP_TYPE_CUBE_UV )\n\t\tiblIrradiance += getLightProbeIndirectIrradiance( /*lightProbe,*/ geometry, maxMipLevel );\n\t#endif\n#endif\n#if defined( USE_ENVMAP ) && defined( RE_IndirectSpecular )\n  vec3 indirectRadiance = getLightProbeIndirectRadiance( /*specularLightProbe,*/ geometry.viewDir, geometry.normal, material.specularRoughness, maxMipLevel );\n\n  vec3 worldNormal = inverseTransformDirection( geometry.normal, viewMatrix );\n  \n  vec3 reflectVec = reflect(cameraDirection, worldNormal);\n  vec4 billboardClr = computeAllBillboardReflections(vPosition, reflectVec, roughnessFactor, envMapIntensity);\n\n  radiance = mix(indirectRadiance, billboardClr.rgb, billboardClr.a);\n\n\t#ifdef CLEARCOAT\n\t\tclearcoatRadiance += getLightProbeIndirectRadiance( /*specularLightProbe,*/ geometry.viewDir, geometry.clearcoatNormal, material.clearcoatRoughness, maxMipLevel );\n\t#endif\n#else\n  vec3 worldNormal = inverseTransformDirection( geometry.normal, viewMatrix );\n  \n  vec3 reflectVec = reflect(cameraDirection, worldNormal);\n  vec4 billboardClr = computeAllBillboardReflections(vPosition, reflectVec, roughnessFactor, 1.);\n\n  radiance = billboardClr.rgb;\n#endif\n",I=function(e,r){return"\nuniform sampler2D billboardTextures[BILLBOARD_TEXTURE_COUNT];\n\nstruct BillboardReflection {\n  mat4 matrixWorld;\n  float rayFalloff;\n  vec3 color;\n  float opacity;\n};\n\nuniform BillboardReflection billboardReflections[BILLBOARD_COUNT];\n".replace(/BILLBOARD_COUNT/g,e).replace(/BILLBOARD_TEXTURE_COUNT/g,r)},D=function(e){return(C+"\nvec4 computeAllBillboardReflections(vec3 wPos, vec3 wReflectVec, float roughnessValue, float envMapIntensity){\n      vec4 reflectClr = vec4(0.);\n      \n      roughnessValue = clamp(roughnessValue, 0., 1.);\n\n      // inout parameter of the billboardReflection function to take care of overlapping opaque billboards\n      float shortestOpaqueBillboardDistance = 3.402823466e+38; // FLT_MAX\n\n      vec4 currentBillboardReflectClr;\n\n      // go through each billboard\n      #pragma unroll_loop_start\n      for(int i = 0; i < BILLBOARD_COUNT; i++){\n\n        // skip hidden billboards\n        if(billboardReflections[i].opacity != 0.){\n          currentBillboardReflectClr = computeBillboardReflection(\n            wPos, wReflectVec, shortestOpaqueBillboardDistance, roughnessValue,\n            billboardReflections[i].matrixWorld, billboardTextures[i], billboardReflections[i].color, billboardReflections[i].rayFalloff,\n            billboardReflections[i].opacity\n          );\n\n          // blend the reflected colors, if the current billboard was opaque, then reflectClr is equal to currentBillboardReflectClr\n          reflectClr = mix(reflectClr, currentBillboardReflectClr, currentBillboardReflectClr.a);\n        }\n        \n      }\n      #pragma unroll_loop_end\n\n      return reflectClr * envMapIntensity;\n    }\n".replace(/BILLBOARD_COUNT/g,e)).replace(O,j)},E=Object(_.a)("billboards"),T=function(){function e(){Object(h.a)(this,e),Object.defineProperty(this,E,{writable:!0,value:[]})}return Object(x.a)(e,[{key:"create",value:function(e){var r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},n=this.createFromTextureAndMatrix(e.material.map,e.matrixWorld,r);if("undefined"===typeof r.opacity)Object.defineProperty(n,"opacity",{get:function(){return e.visible&&e.material.visible&&n.visible?e.material.opacity:0}});else{var t=n.opacity;Object.defineProperty(n,"opacity",{set:function(e){t=e},get:function(){return n.visible?t:0}})}return"undefined"===typeof r.color&&Object.defineProperty(n,"color",{get:function(){return e.material.color}}),n}},{key:"createFromTextureAndMatrix",value:function(e,r){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},t=n.rayFalloff,a=void 0===t?0:t,o=n.color,l=void 0===o?new g.Color:o,i=n.opacity,c=void 0===i?1:i,s=n.visible,u=void 0===s||s,d={texture:e,matrixWorld:r,rayFalloff:a,color:l,opacity:c,visible:u};return Object(y.a)(this,E)[E].push(d),d}},{key:"enableReflection",value:function(e){var r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},n=r.roughnessMapBlur,t=void 0===n||n,a=r.roughnessMapBlurIntensity,o=void 0===a?.85:a,l=r.roughness,i=void 0===l?void 0:l,c=r.envMapIntensity,s=void 0===c?void 0:c,u=Object(y.a)(this,E)[E].length;if(0!==u){for(var d=Object(y.a)(this,E)[E].map((function(e){return e.texture})),f=Array.from(new Set(d)),b=f.length,v=Object(y.a)(this,E)[E].map((function(e){return f.indexOf(e.texture)})),p=D(u),m=0;m<u;m++)p=p.replace(new RegExp("billboardTextures\\[\\s"+m+"\\s\\]","g"),"billboardTextures[ "+v[m]+" ]");e.defines.REFLECTION_ROUGHNESS_BLUR=t&&e.roughnessMap,e.defines.REFLECTION_ROUGHNESS_MAP_BLUR_INTENSITY=o.toFixed(5),e.uniforms.billboardTextures={value:f},e.uniforms.billboardReflections={value:Array.from(Object(y.a)(this,E)[E])},e.vertexShader=e.vertexShader.replace("#include <common>","#include <common>\n"+R).replace("#include <project_vertex>","#include <project_vertex>\n"+M);var g="number"===typeof i?B.replace(/roughnessFactor/g,i.toFixed(5)):B;"number"===typeof s&&(g=g.replace(/envMapIntensity/g,s.toFixed(5))),e.fragmentShader=e.fragmentShader.replace("#include <common>","#include <common>\n"+R+"\n"+I(u,b)).replace("#include <bsdfs>","#include <bsdfs>\n"+p).replace("#include <lights_fragment_maps>",g)}}}]),e}(),S=n(17);function L(){var e=Object(o.useRef)(),r=Object(c.g)(),n=r.camera,t=r.gl,a=r.scene;return n.position.y=3,a.background=a.environment,Object(c.e)((function(){e.current.update()})),Object(S.jsx)("orbitControls",{ref:e,args:[n,t.domElement],enablePan:!1,enableDamping:!0,dampingFactor:.1,rotateSpeed:.5})}function P(){var e=Object(c.f)(b.a,"/billboard_low.glb").nodes,r=Object(o.useRef)(),n=Object(o.useRef)(),t=Object(o.useRef)(),a=new T;a.roughnessBlur=!0,Object(c.e)((function(){var e=1300;r.current.rotation.x=-Math.PI/2+.5*Math.sin(Date.now()/e),r.current.rotation.z=Math.PI,r.current.position.x=Math.cos(Date.now()/e),r.current.position.y=.5*Math.abs(Math.sin(Date.now()/e))+1.95,r.current.position.z=Math.cos(Date.now()/e)-2,n.current.rotation.y+=.003,n.current.rotation.y%=2*Math.PI,n.current.position.set(2.25,1.7,2.5)}));var s,u=Object(c.g)(),d=u.scene,f=u.gl,v=new g.PMREMGenerator(f);v.compileEquirectangularShader();var h=Object(m.b)((function(){return{ground:Object(m.a)({roughness:{value:e.ground.material.roughnessMap?3:.1,min:0,max:e.ground.material.roughnessMap?6:1,step:.1},metalness:{value:1,min:0,max:1,step:.1},envMapIntensity:{value:1,min:0,max:1,step:.1},normalScale:{value:.1,min:0,max:1,step:.05},color:"#eee",roughnessMap:{value:!0,onChange:function(r){e.ground.material._roughnessMap||(e.ground.material._roughnessMap=e.ground.material.roughnessMap),e.ground.material.roughnessMap=r?e.ground.material._roughnessMap:null,e.ground.material.needsUpdate=!0,C({roughness:e.ground.material.roughnessMap?3:.1})}},"sky envMap":{value:!1,onChange:function(e){if(d.background){var r=e?"blue_sky":"garden";(new p.a).load("/"+r+".hdr",(function(e){s&&s.dispose();var r=(s=v.fromEquirectangular(e)).texture;r.minFilter=g.LinearFilter,d.background=r,d.environment=r,e.dispose()}))}}}}),colorPatternBillboard:Object(m.a)({visible:{value:!0,onChange:function(e){r.current&&(r.current.visible=e)}},opacity:{value:1,min:0,max:1,step:.1,onChange:function(e){r.current&&(r.current.material.opacity=e)}},reflection:{value:!0,onChange:function(e){r.current._reflection&&(r.current._reflection.visible=e)}},color2:{label:"color",value:"#ffffff",onChange:function(e){r.current&&r.current.material.color.setStyle(e)}},rayFalloff:{value:0,min:0,max:.4,step:.01,onChange:function(e){r.current._reflection&&(r.current._reflection.rayFalloff=e)}}}),threejsBillboard:Object(m.a)({visible2:{label:"visible",value:!0,onChange:function(e){n.current&&(n.current.visible=e)}},opacity2:{label:"opacity",value:1,min:0,max:1,step:.1,onChange:function(e){n.current&&(n.current.material.opacity=e)}},reflection2:{label:"reflection",value:!0,onChange:function(e){n.current._reflection&&(n.current._reflection.visible=e)}},reflectionColorMultiplier2:{label:"reflectionColorMultiplier",value:1.25,min:0,max:3,step:.125,onChange:function(e){n.current._reflection&&(n.current._reflection.reflectionColorMultiplier=e)}},rayFalloff2:{label:"rayFalloff",value:0,min:0,max:.4,step:.01,onChange:function(e){n.current._reflection&&(n.current._reflection.rayFalloff=e)}}},{collapsed:!0})}})),x=Object(i.a)(h,2),y=x[0],_=y.roughness,O=y.metalness,j=y.envMapIntensity,R=y.normalScale,M=y.color,C=x[1];return Object(o.useEffect)((function(){r.current._reflection=a.create(r.current,{reflectionColorMultiplier:1.25}),n.current._reflection=a.create(n.current,{reflectionColorMultiplier:1.25}),t.current.material.onBeforeCompile=function(e){return a.enableReflection(e)};var o=new g.MeshBasicMaterial({map:e.billboard.material.map,side:g.DoubleSide,transparent:!0,depthWrite:!1}),l=new g.MeshBasicMaterial({map:e.billboard2.material.map,side:g.DoubleSide,transparent:!0,depthWrite:!1});e.billboard.material=o,e.billboard2.material=l}),[]),e.ground.material.roughness=_,e.ground.material.metalness=O,e.ground.material.envMapIntensity=j,e.ground.material.normalScale=new g.Vector2(R,R),e.ground.material.color.setStyle(M),Object(S.jsxs)("object3D",{rotation:[0,Math.PI/2,0],children:[Object(S.jsx)("mesh",Object(l.a)(Object(l.a)({ref:r},e.billboard),{},{scale:[2,2,2],dispose:null})),Object(S.jsx)("mesh",Object(l.a)(Object(l.a)({ref:n},e.billboard2),{},{dispose:null})),Object(S.jsx)("mesh",Object(l.a)(Object(l.a)({ref:t},e.ground),{},{dispose:null}))]})}function w(){return Object(S.jsx)(S.Fragment,{children:Object(S.jsxs)(c.a,{children:[Object(S.jsx)(d.a,{}),Object(S.jsx)("pointLight",{position:[20,20,20],intensity:.5}),Object(S.jsxs)(o.Suspense,{fallback:null,children:[Object(S.jsx)(P,{}),Object(S.jsx)(L,{}),Object(S.jsx)(f.a,{files:"garden.hdr",path:"/"}),Object(S.jsxs)(s.b,{multisampling:0,children:[Object(S.jsx)(s.a,{intensity:.3,luminanceThreshold:.475,width:1024}),Object(S.jsx)(s.c,{edgeDetectionMode:u.j.DEPTH})]})]})]})})}Object(c.d)({OrbitControls:v.a}),a.a.render(Object(S.jsx)(w,{}),document.getElementById("root"))}},[[75,1,2]]]);
//# sourceMappingURL=main.5bedd29a.chunk.js.map